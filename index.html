<!DOCTYPE html>
<html>
<head>
    <title>Telegram Media Gallery</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Include Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
<div class="container mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">Telegram Media Gallery</h1>
  <div class="mb-4 flex flex-wrap gap-2">
    <input type="file" id="fileInput" multiple class="border border-gray-300 p-2 rounded" />
    <button id="uploadButton" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Upload Files</button>
    <button id="deleteButton" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Delete Selected</button>
  </div>
  <div id="mediaContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
    <!-- Media thumbnails will be inserted here -->
  </div>
</div>

<!-- Hidden dummy elements to ensure Tailwind includes necessary classes -->
<div style="display:none;">
  <div class="relative border rounded overflow-hidden"></div>
  <label class="absolute top-2 left-2 z-10 bg-white bg-opacity-75 p-1 rounded"></label>
  <div class="w-full aspect-square"></div>
  <img class="object-cover w-full h-full" />
  <input class="w-5 h-5" type="checkbox" />
</div>

<script>
// API base URL
const API_BASE = 'https://my-cloud-1kaj.onrender.com';

// Load files on page load
document.addEventListener('DOMContentLoaded', () => {
    loadFiles();

    document.getElementById('uploadButton').addEventListener('click', uploadFiles);
    document.getElementById('deleteButton').addEventListener('click', deleteSelected);
});

// Fetch and display media files
async function loadFiles() {
    try {
        const response = await fetch(API_BASE + '/files');
        if (!response.ok) {
            console.error('Failed to fetch files:', response.status, response.statusText);
            return;
        }
        const files = await response.json();
        displayMedia(files);
    } catch (error) {
        console.error('Error fetching files:', error);
    }
}

// Display media thumbnails in grid
function displayMedia(files) {
    const container = document.getElementById('mediaContainer');
    container.innerHTML = '';
    files.forEach(file => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'relative border rounded overflow-hidden';

        // Checkbox for selection
        const checkboxLabel = document.createElement('label');
        checkboxLabel.className = 'absolute top-2 left-2 z-10 bg-white bg-opacity-75 p-1 rounded';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'media-checkbox w-5 h-5';
        checkbox.dataset.id = file.id;
        checkboxLabel.appendChild(checkbox);
        itemDiv.appendChild(checkboxLabel);

        // Link to full image
        const link = document.createElement('a');
        link.href = API_BASE + '/stream/' + file.id;
        link.target = '_blank';

        // Image thumbnail
        const imgContainer = document.createElement('div');
        imgContainer.className = 'w-full aspect-square';
        const img = document.createElement('img');
        img.src = API_BASE + '/stream/' + (file.thumbnail_id ? file.thumbnail_id : file.id);
        img.alt = 'Media';
        img.className = 'object-cover w-full h-full';
        imgContainer.appendChild(img);
        link.appendChild(imgContainer);

        itemDiv.appendChild(link);
        container.appendChild(itemDiv);
    });
}

// Upload selected files
async function uploadFiles() {
    const fileInput = document.getElementById('fileInput');
    const files = fileInput.files;
    if (files.length === 0) {
        alert('Please select files to upload.');
        return;
    }
    const formData = new FormData();
    for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
    }

    try {
        const response = await fetch(API_BASE + '/upload-multiple', {
            method: 'POST',
            body: formData
        });
        if (response.ok) {
            alert('Files uploaded successfully.');
            fileInput.value = null;
            loadFiles(); // Refresh the gallery
        } else {
            console.error('Upload failed:', response.status, response.statusText);
            alert('Upload failed.');
        }
    } catch (error) {
        console.error('Error uploading files:', error);
    }
}

// Delete selected media files
async function deleteSelected() {
    const checkboxes = document.querySelectorAll('.media-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select items to delete.');
        return;
    }
    const idsToDelete = Array.from(checkboxes).map(cb => cb.dataset.id);
    try {
        const response = await fetch(API_BASE + '/delete-multiple', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ids: idsToDelete })
        });
        if (response.ok) {
            alert('Selected items deleted successfully.');
            loadFiles(); // Refresh the gallery
        } else {
            console.error('Delete failed:', response.status, response.statusText);
            alert('Delete failed.');
        }
    } catch (error) {
        console.error('Error deleting files:', error);
    }
}
</script>
</body>
</html>